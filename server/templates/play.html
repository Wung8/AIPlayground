<!-- backend/templates/play.html -->
{% extends "base.html" %}
{% set active = "environments" %}
{% set title = "Play - " ~ env.title %}

{% block styles %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/play.css') }}">
{% endblock %}

{% block content %}
  <div class="play-shell">
    {% include "_play_sidebar.html" %}

    <main class="play-main">
      <div class="play-main-head">
        <a class="play-back" href="{{ url_for('environments', slug=env.slug) }}">Back</a>

        <div class="play-main-row">
          <div class="play-title">{{ env.title }}</div>

          <div class="play-difficulty">
            <button class="play-diff-btn" data-diff="easy">Easy</button>
            <button class="play-diff-btn" data-diff="medium">Med</button>
            <button class="play-diff-btn" data-diff="hard">Hard</button>
          </div>

          <div></div> <!-- empty right spacer -->
        </div>
      </div>

      <div class="play-stage">
        <!-- replace this div with your real canvas -->
        <canvas id="game" width="800" height="400"></canvas>

        <div class="play-stage-controls">
          <button class="play-stage-btn" type="button" id="btnReset">Reset</button>
          <label class="play-stage-debug">
            Debug <input type="checkbox" id="chkDebug" />
          </label>
          <button class="play-stage-btn" type="button" id="btnFullscreen">Fullscreen</button>
        </div>
      </div>

      <div class="play-debug">
        <div class="play-debug-box" id="debugBox"></div>
      </div>
    </main>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    window.__ENV_SLUG__ = {{ env.slug|tojson }};
  </script>
  <script type="module" src="{{ url_for('static', filename='play_handler.js') }}"></script>

  <script>
    (function () {
      const tabs = document.querySelectorAll(".play-tab");
      const panes = {
        browse: document.getElementById("tab-browse"),
        mine: document.getElementById("tab-mine"),
      };

      function setTab(name) {
        tabs.forEach(t => {
          const active = t.dataset.tab === name;
          t.classList.toggle("is-active", active);
          t.setAttribute("aria-selected", active ? "true" : "false");
        });
        panes.browse.classList.toggle("is-active", name === "browse");
        panes.mine.classList.toggle("is-active", name === "mine");
      }

      const params = new URLSearchParams(window.location.search);
      const initialTab = params.get("tab");

      if (initialTab === "mine") {
        setTab("mine");
      } else {
        setTab("browse");
      }

      tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

      const btn = document.getElementById("eloFilterBtn");
      const pop = document.getElementById("eloPop");
      if (btn && pop) {
        btn.addEventListener("click", () => {
          const open = !pop.classList.contains("is-open");
          pop.classList.toggle("is-open", open);
          btn.setAttribute("aria-expanded", open ? "true" : "false");
        });
      }

      const clear = document.getElementById("eloClear");
      if (clear) {
        clear.addEventListener("click", () => {
          const min = document.getElementById("eloMin");
          const max = document.getElementById("eloMax");
          if (min) min.value = "";
          if (max) max.value = "";
          if (btn) btn.textContent = "Elo: Any";
        });
      }

      // player selection highlighting + bot-to-field fill
      const playerInputs = Array.from(document.querySelectorAll(".play-input"));
      let activePlayerIdx = 0;

      function ensureHighlightStyles() {
        if (document.getElementById("playerHighlightStyle")) return;
        const style = document.createElement("style");
        style.id = "playerHighlightStyle";
        style.textContent = `
          .play-input.is-active-player{
            outline: 2px solid rgba(255, 255, 255, 0.35);
            box-shadow: 0 0 0 4px rgba(255, 255, 255, 0.10);
          }

          /* search results list injected under the search bar */
          .play-search-results{
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
          }

          /* single elo sort button states */
          .play-sort-pill.is-neutral{
            opacity: 0.55;
          }
        `;
        document.head.appendChild(style);
      }

      function setActivePlayer(idx) {
        if (!playerInputs.length) return;
        activePlayerIdx = ((idx % playerInputs.length) + playerInputs.length) % playerInputs.length;

        playerInputs.forEach((inp, i) => {
          inp.classList.toggle("is-active-player", i === activePlayerIdx);
        });

        const active = playerInputs[activePlayerIdx];
        if (active) active.focus({ preventScroll: true });
      }

      ensureHighlightStyles();
      setActivePlayer(0);

      playerInputs.forEach((inp, idx) => {
        inp.addEventListener("focus", () => setActivePlayer(idx));
        inp.addEventListener("click", () => setActivePlayer(idx));
      });

      function fillActivePlayer(name) {
        if (!playerInputs.length) return;
        const active = playerInputs[activePlayerIdx];
        if (!active) return;

        active.value = name;

        // progress to next, loop back after last
        setActivePlayer(activePlayerIdx + 1);
      }

      document.addEventListener("click", (e) => {
        const btnRow = e.target.closest(".bot-row-btn, .bot-select-btn");
        if (!btnRow) return;

        const botName = btnRow.dataset.bot || "";
        if (!botName) return;

        fillActivePlayer(botName);
      });

      // ===== browse: file-contains search results shown under the search bar =====
      const searchInput = document.getElementById("botSearch");
      const browseList = document.getElementById("browseList");

      function ensureResultsContainer() {
        if (!searchInput) return null;
        const searchBlock = searchInput.closest(".play-search");
        if (!searchBlock) return null;

        let results = document.getElementById("botSearchResults");
        if (results) return results;

        results = document.createElement("div");
        results.id = "botSearchResults";
        results.className = "play-search-results";
        results.style.display = "none";

        // insert right below the search row (so it appears under the search bar)
        const searchRow = searchBlock.querySelector(".play-search-row");
        if (searchRow && searchRow.parentNode) {
          searchRow.parentNode.insertBefore(results, searchRow.nextSibling);
        } else {
          searchBlock.appendChild(results);
        }

        return results;
      }

      function escapeHtml(s) {
        return String(s ?? "").replace(/[&<>"']/g, (c) => (
          { "&":"&amp;", "<":"&lt;", ">":"&gt;", '"':"&quot;", "'":"&#39;" }[c]
        ));
      }

      let searchTimer = null;
      async function runFileSearch(q) {
        const results = ensureResultsContainer();
        if (!results) return;

        const query = (q || "").trim();
        if (!query) {
          results.innerHTML = "";
          results.style.display = "none";
          return;
        }

        try {
          const slug = window.__ENV_SLUG__ || "";
          const res = await fetch(`/bot_search/${encodeURIComponent(slug)}?q=${encodeURIComponent(query)}`, {
            headers: { "X-Requested-With": "XMLHttpRequest" }
          });
          const data = await res.json();

          const items = Array.isArray(data.results) ? data.results : [];
          results.innerHTML = items.map((b) => {
            return `
              <button class="bot-row bot-row-btn" type="button" data-bot="${escapeHtml(b.name)}">
                <div class="bot-name">${escapeHtml(b.name)}</div>
                <div class="bot-meta">
                  <div class="bot-elo">elo: ${escapeHtml(b.elo)}</div>
                  <div class="bot-by">by: ${escapeHtml(b.by)}</div>
                </div>
              </button>
            `;
          }).join("");

          results.style.display = "flex";

          // apply current sort to the results list too
          applyCurrentSort(results);
        } catch (e) {
          results.innerHTML = "";
          results.style.display = "none";
        }
      }

      if (searchInput) {
        searchInput.addEventListener("input", () => {
          clearTimeout(searchTimer);
          searchTimer = setTimeout(() => runFileSearch(searchInput.value), 180);
        });
      }

      // ===== single elo sort button: neutral (alpha), up (elo desc), down (elo asc) =====
      const eloSortBtn = document.getElementById("sortByElo");
      let sortState = 0; // 0=neutral(alpha), 1=elo desc, 2=elo asc

      function getBotNameFromRow(row) {
        const el = row.querySelector(".bot-name");
        return (el ? el.textContent : row.dataset.bot || "").trim().toLowerCase();
      }

      function getBotEloFromRow(row) {
        // supports either data-elo, or parsing "elo: ####"
        const d = row.getAttribute("data-elo");
        if (d != null && d !== "") {
          const n = Number(d);
          return Number.isFinite(n) ? n : 0;
        }
        const el = row.querySelector(".bot-elo");
        const txt = (el ? el.textContent : "").toLowerCase();
        const m = txt.match(/(-?\d+(\.\d+)?)/);
        if (!m) return 0;
        const n = Number(m[1]);
        return Number.isFinite(n) ? n : 0;
      }

      function sortContainer(container, mode) {
        if (!container) return;

        // only sort bot rows (buttons/divs using bot-row class)
        const rows = Array.from(container.querySelectorAll(".bot-row"));
        if (!rows.length) return;

        rows.sort((a, b) => {
          if (mode === 0) {
            const an = getBotNameFromRow(a);
            const bn = getBotNameFromRow(b);
            return an.localeCompare(bn);
          }
          if (mode === 1) {
            return getBotEloFromRow(b) - getBotEloFromRow(a);
          }
          return getBotEloFromRow(a) - getBotEloFromRow(b);
        });

        rows.forEach(r => container.appendChild(r));
      }

      function applyCurrentSort(maybeResultsContainer) {
        // always sort main browse list
        sortContainer(browseList, sortState);

        // also sort injected results list if provided or exists
        const results = maybeResultsContainer || document.getElementById("botSearchResults");
        if (results && results.style.display !== "none") {
          sortContainer(results, sortState);
        }
      }

      function updateEloBtnUI() {
        if (!eloSortBtn) return;

        if (sortState === 0) {
          eloSortBtn.textContent = "Elo";
          eloSortBtn.classList.add("is-neutral");
        } else if (sortState === 1) {
          eloSortBtn.textContent = "Elo ▲";
          eloSortBtn.classList.remove("is-neutral");
        } else {
          eloSortBtn.textContent = "Elo ▼";
          eloSortBtn.classList.remove("is-neutral");
        }
      }

      if (eloSortBtn) {
        // initialize button to greyed-out neutral state
        sortState = 0;
        updateEloBtnUI();

        eloSortBtn.addEventListener("click", () => {
          sortState = (sortState + 1) % 3;
          updateEloBtnUI();
          applyCurrentSort();
        });

        // initial sort alphabetically
        applyCurrentSort();
      }
    })();
  </script>

  <script>
    window.addEventListener("keydown", function (e) {
      const keysToBlock = ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "];

      if (keysToBlock.includes(e.key)) {
        e.preventDefault();
      }
    });
  </script>

  <script>
    document.addEventListener("click", async function (e) {
      if (!e.target.classList.contains("bot-delete-btn")) return;

      const row = e.target.closest(".bot-row");
      const botId = row.dataset.id;

      if (!confirm("Delete this bot permanently?")) return;

      const res = await fetch(`/delete_bot/${botId}`, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      });

      const data = await res.json();

      if (data.success) {
        row.remove();
      } else {
        alert(data.message || "Delete failed.");
      }
    });
  </script>
{% endblock %}