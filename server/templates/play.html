<!-- backend/templates/play.html -->
{% extends "base.html" %}
{% set active = "environments" %}
{% set title = "Play - " ~ env.title %}

{% block content %}
  <div class="play-shell">
    {% include "_play_sidebar.html" %}

    <main class="play-main">
      <div class="play-main-head">
        <a class="play-back" href="{{ url_for('environments', slug=env.slug) }}">Back</a>
        <div class="play-title">{{ env.title }}</div>
      </div>

      <div class="play-stage">
        <!-- replace this div with your real canvas -->
        <canvas id="game" width="800" height="400"></canvas>

        <div class="play-stage-controls">
          <button class="play-stage-btn" type="button" id="btnReset">Reset</button>
          <label class="play-stage-debug">
            Debug <input type="checkbox" id="chkDebug" />
          </label>
          <button class="play-stage-btn" type="button" id="btnFullscreen">Fullscreen</button>
        </div>
      </div>

      <div class="play-debug">
        <div class="play-debug-box" id="debugBox"></div>
      </div>
    </main>
  </div>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <script>
    window.__ENV_SLUG__ = {{ env.slug|tojson }};
  </script>
  <script type="module" src="{{ url_for('static', filename='play_handler.js') }}"></script>

  <script>
    (function () {
      const tabs = document.querySelectorAll(".play-tab");
      const panes = {
        browse: document.getElementById("tab-browse"),
        mine: document.getElementById("tab-mine"),
      };

      function setTab(name) {
        tabs.forEach(t => {
          const active = t.dataset.tab === name;
          t.classList.toggle("is-active", active);
          t.setAttribute("aria-selected", active ? "true" : "false");
        });
        panes.browse.classList.toggle("is-active", name === "browse");
        panes.mine.classList.toggle("is-active", name === "mine");
      }

      const params = new URLSearchParams(window.location.search);
      const initialTab = params.get("tab");

      if (initialTab === "mine") {
        setTab("mine");
      } else {
        setTab("browse");
      }

      tabs.forEach(t => t.addEventListener("click", () => setTab(t.dataset.tab)));

      const btn = document.getElementById("eloFilterBtn");
      const pop = document.getElementById("eloPop");
      if (btn && pop) {
        btn.addEventListener("click", () => {
          const open = !pop.classList.contains("is-open");
          pop.classList.toggle("is-open", open);
          btn.setAttribute("aria-expanded", open ? "true" : "false");
        });
      }

      const clear = document.getElementById("eloClear");
      if (clear) {
        clear.addEventListener("click", () => {
          const min = document.getElementById("eloMin");
          const max = document.getElementById("eloMax");
          if (min) min.value = "";
          if (max) max.value = "";
          if (btn) btn.textContent = "Elo: Any";
        });
      }
    })();
  </script>

  <script>
    window.addEventListener("keydown", function (e) {
      const keysToBlock = ["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", " "];

      if (keysToBlock.includes(e.key)) {
        e.preventDefault();
      }
    });
  </script>

  <script>
    document.addEventListener("click", async function (e) {
      if (!e.target.classList.contains("bot-delete-btn")) return;

      const row = e.target.closest(".bot-row");
      const botId = row.dataset.id;

      if (!confirm("Delete this bot permanently?")) return;

      const res = await fetch(`/delete_bot/${botId}`, {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest"
        }
      });

      const data = await res.json();

      if (data.success) {
        row.remove();
      } else {
        alert(data.message || "Delete failed.");
      }
    });
    </script>
{% endblock %}
